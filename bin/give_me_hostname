#!/usr/bin/env bash

readonly mode="$1"

set -e -o pipefail -o nounset

dsh_hosts() {
    local file
    file="$HOME/.dsh/group/all"
    if [ -f "$file" ]; then
        grep -vE '^#' "$file"
    fi
}

known_hosts() {
    local file
    file="$HOME/.ssh/known_hosts"
    if [ -f "$file" ]; then
        awk '{print $1}' "$file"    \
            | grep -v ^\|           \
            | cut -d, -f 1          \
            | sed -e 's/\[//g'      \
            | sed -e 's/\]//g'      \
            | cut -d: -f1           \
            | grep -v ssh-rsa
    fi
}

bash_history() {
    local file
    file="$HOME/.bash_history"
    if [ -f "$file" ]; then
        grep -E "^host|^dig|^drill|^ping|^whois" "$file" \
            | awk '{print $NF}'
    fi
}

ssh_config() {
    local file
    file="$HOME/.ssh/config"
    if [ -d "$(dirname "$file")" ]; then
        awk '/^Host/ && ! /*/ {print $2}' "$file"
    fi
}

ssh_config_d() {
    local file
    file="$HOME/.ssh/config.d/*"
    if [ -d "$(dirname "$file")" ]; then
        awk '/^Host/ && ! /*/ {print $2}' $file
    fi
}

main() {
    case "$mode" in
        "dsh") dsh_hosts | sort -u;;
        "hosts") known_hosts | sort -u;;
        "ssh")
            (
                dsh_hosts
                ssh_config_d
                known_hosts
            ) | grep -vE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" | sort -u
        ;;
        "ips")
            (
                bash_history
                known_hosts
            ) | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b" | sort -u
        ;;
        *)
            (
                ssh_config_d
                dsh_hosts
                known_hosts
                bash_history
            ) | grep -vE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b|^@|^\+|^\.'" | sort -u
        ;;
    esac

    return 0
}
main
