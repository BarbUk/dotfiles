#!/usr/bin/env bash

host="$1"
port="$2"

set -e -o nounset

fzf="fzf  --select-1 --height 40%"

hostname_list="$HOME/.dotfiles/bin/give_me_hostname ssh"

if [ -z "$host" ]; then
    host="$( $hostname_list | $fzf )"
fi

if [ -z "$port" ]; then
    port='22'
fi

if [[ ${host} == *@*  ]] ; then
    resolvable_host="${host/*@/}"
else
    resolvable_host=${host}
fi

if [ "$(uname)" = "Darwin" ]; then
    resolve="$(dscacheutil -q host -a name "$resolvable_host" | wc -l)"
else
    resolve="$(getent hosts "$resolvable_host" | wc -l)"
fi

if [ $resolve = 0 ]; then
    host="$( $hostname_list | $fzf --query="$host" )"
fi

rsync -avz --copy-links --no-o --no-g  -e "ssh -p $port" \
    --exclude='.git/' --exclude='.vim/backup/*' \
    --exclude='doc/' --exclude='test/' \
    --exclude='docs/' --exclude='tests/' \
    --exclude='.vim/swp/*' --exclude='video' \
    --exclude='*.md' --exclude='.travis.yml' \
    --exclude='vagrant*' --exclude='Vagrantfile' \
    --exclude='Gemfile' --exclude='Rakefile' \
    --exclude='LICENSE' --exclude='Rakefile' \
    ~/.dotfiles/server/ \
    "$host":

echo -ne "\033]0;$host\007"

ssh -p "$port" -t "$host" "
if test \$SSH_AUTH_SOCK; then
    ln -sf \$SSH_AUTH_SOCK ~/.ssh/ssh_auth_sock
fi
export h=$host
export TERM=xterm-256color

if ! tmux list-session | grep -qF buk
then
   tmux new-session -d -s buk
fi

tmux attach -t buk"
