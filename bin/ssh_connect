#!/usr/bin/env bash
set -e -o nounset

readonly port="${2:-22}"

readonly rsync_options="--archive --compress --copy-links --no-owner --no-group --sparse --partial --ipv4"
readonly ssh_options="-4 -o PreferredAuthentications=publickey -p $port"

readonly fzf="fzf --select-1 --height 30% --tiebreak=begin,index --reverse --inline-info"
readonly dotdir="$HOME/.dotfiles"
readonly hostname_list="$dotdir/bin/give_me_hostname ssh"

host="${1:-$( $hostname_list | $fzf )}"

if [[ ${host} == *@*  ]] ; then
    resolvable_host="${host/*@/}"
else
    resolvable_host=${host}
fi

if [ "$(uname)" = "Darwin" ]; then
    resolve="$(dscacheutil -q host -a name "$resolvable_host" | wc -l)"
else
    resolve="$(getent hosts "$resolvable_host" | wc -l)"
fi

if [[ $resolve -eq 0 ]]; then
    host="$( $hostname_list | $fzf --query="$host" )"
fi

set -u
echo "Rsyncing dotfiles..."
# shellcheck disable=SC2086
rsync $rsync_options --rsh "ssh $ssh_options" \
    --exclude-from "$dotdir/apps/rsync_exclude.list" \
    "$dotdir/server/" \
    "$host": || true

echo -ne "\033]0;$host\007"

echo "Sshing..."
# shellcheck disable=SC2086
# shellcheck disable=SC2029
ssh $ssh_options -t "$host" "
if test \$SSH_AUTH_SOCK; then
    ln -sf \$SSH_AUTH_SOCK ~/.ssh/ssh_auth_sock
fi
export h=$host
export TERM=xterm-256color

if ! tmux list-session 2> /dev/null | grep -qF buk; then
   tmux new-session -d -s buk
fi

tmux at -t buk"
